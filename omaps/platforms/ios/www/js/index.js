// Generated by CoffeeScript 1.6.3
(function() {
  var load, location, makeMap, makeMarker, url;

  location = {
    city: 'Nice',
    country: 'France',
    lat: 43.7034,
    lng: 7.2663
  };

  url = 'data/' + location.country + '.' + location.city + '.json';

  console.log('requesting "' + url + '"...');

  makeMap = function(data) {
    var datum, map, _i, _len, _results;
    console.log('init GMaps...');
    map = new GMaps({
      div: '#map',
      lat: location.lat,
      lng: location.lng,
      height: window.innerHeight,
      width: window.innerWidth
    });
    GMaps.geolocate({
      success: function(position) {
        return map.setCenter(position.coords.latitude, position.coords.longitude);
      },
      error: function(error) {
        return console.log('Geolocation failed: ' + error.message);
      }
    });
    _results = [];
    for (_i = 0, _len = data.length; _i < _len; _i++) {
      datum = data[_i];
      _results.push(makeMarker(datum, map));
    }
    return _results;
  };

  makeMarker = function(datum, map) {
    var html;
    html = "<img class=\"image\" src=\"" + datum.image_url + "\" />\n<span class=\"name\">" + datum.name + "</span>\n<img class=\"rating\" src=\"" + datum.rating_img_url_small + "\" />\n<span class=\"phone\">" + datum.display_phone + "</span>\n<span class=\"address\">" + datum.location.address[0] + "</span>\n";
    return GMaps.geocode({
      address: datum.location.address[0] + ', ' + datum.location.city + ', ' + datum.location.postal_code + ', ' + datum.location.country_code,
      callback: function(results, status) {
        var latlng;
        if (status === 'OK') {
          latlng = results[0].geometry.location;
          return map.addMarker({
            lat: latlng.lat(),
            lng: latlng.lng(),
            infoWindow: {
              content: html
            }
          });
        }
      }
    });
  };

  load = function(res) {
    var data;
    data = JSON.parse(res);
    console.log(data);
    return makeMap(data);
  };

  uxhr(url, null, {
    complete: load
  });

}).call(this);
